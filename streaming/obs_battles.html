<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fouler-Play OBS v3 â€” 4-Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0f1b;
            --accent-red: #ff2e63;
            --accent-blue: #08d9d6;
            --accent-green: #50fa7b;
            --accent-yellow: #f1fa8c;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #eaeaea;
            --bar-height: 44px;
            --divider: 1px solid rgba(255, 255, 255, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: 'Outfit', sans-serif;
            color: var(--text-main);
        }

        /* =============================================
           ROOT LAYOUT
           ============================================= */
        .app-container {
            display: flex;
            width: 100%;
            height: calc(100% - var(--bar-height));
        }

        /* =============================================
           EMERALD PANEL â€” Left 55%
           ============================================= */
        .emerald-panel {
            width: 55%;
            flex-shrink: 0;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #1a2e1a 0%, #0a0f0a 100%);
            border-right: 2px solid rgba(80, 250, 123, 0.25);
        }

        .emerald-panel iframe {
            width: 100%;
            height: 100%;
            border: none;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .emerald-panel iframe.visible {
            opacity: 1;
        }

        /* Emerald idle/waiting overlay */
        .emerald-idle {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            background: radial-gradient(ellipse at 50% 60%, #152b15 0%, #0a0f0a 70%);
            z-index: 50;
            transition: opacity 0.5s;
        }

        .emerald-idle.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .emerald-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .emerald-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #50fa7b44, #50fa7b11);
            border: 2px solid #50fa7b66;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: emerald-pulse 3s ease-in-out infinite;
        }

        @keyframes emerald-pulse {
            0%, 100% { box-shadow: 0 0 20px #50fa7b33; }
            50% { box-shadow: 0 0 50px #50fa7b77; }
        }

        .emerald-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 6px;
            color: var(--accent-green);
            text-shadow: 0 0 20px #50fa7b66;
        }

        .emerald-sub {
            font-size: 12px;
            letter-spacing: 2px;
            color: #50fa7b88;
            text-transform: uppercase;
        }

        .emerald-status-text {
            font-size: 14px;
            color: #50fa7b99;
            letter-spacing: 2px;
            animation: blink 2s step-end infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Emerald top badge */
        .emerald-header {
            position: absolute;
            top: 16px;
            left: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }

        /* =============================================
           BATTLES PANEL â€” Right 45%
           ============================================= */
        .battles-panel {
            width: 45%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Each battle slot is 1/3 of battles panel height */
        .battle-slot {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1b 100%);
            border-bottom: var(--divider);
        }

        .battle-slot:last-child {
            border-bottom: none;
        }

        .battle-slot iframe {
            width: 100%;
            height: 100%;
            border: none;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }

        .battle-slot iframe.visible {
            opacity: 1;
        }

        /* =============================================
           BADGES
           ============================================= */
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .badge.red    { color: var(--accent-red);   border-color: var(--accent-red);   box-shadow: 0 0 10px rgba(255,46,99,0.25); }
        .badge.blue   { color: var(--accent-blue);  border-color: var(--accent-blue);  box-shadow: 0 0 10px rgba(8,217,214,0.25); }
        .badge.purple { color: #bd93f9;              border-color: #bd93f9;             box-shadow: 0 0 10px rgba(189,147,249,0.25); }
        .badge.green  { color: var(--accent-green); border-color: var(--accent-green); box-shadow: 0 0 10px rgba(80,250,123,0.25); }
        .badge.dim    { color: #888; border-color: #444; }

        /* =============================================
           SLOT HEADER (compact for small slots)
           ============================================= */
        .ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        .slot-header {
            position: absolute;
            top: 10px;
            left: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* =============================================
           BATTLE CARD (compact bottom strip)
           ============================================= */
        .battle-card {
            position: absolute;
            bottom: 8px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.72);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: 8px 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(120%);
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .battle-card.show {
            transform: translateY(0);
        }

        .opp-info h4 {
            font-size: 9px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 2px;
            letter-spacing: 1px;
        }

        .opp-info div {
            font-size: 15px;
            font-weight: 800;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .match-stats .turn {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent-blue);
            letter-spacing: 1px;
        }

        /* =============================================
           SEARCHING ANIMATION (mini sonar for small slots)
           ============================================= */
        .searching-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            z-index: 50;
            transition: opacity 0.5s;
            gap: 12px;
        }

        .searching-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .sonar {
            width: 90px;
            height: 90px;
            position: relative;
        }

        .sonar-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid var(--accent-blue);
            border-radius: 50%;
            opacity: 0;
            animation: sonar-ping 4s infinite linear;
        }

        .sonar-circle:nth-child(2) { animation-delay: 1s; }
        .sonar-circle:nth-child(3) { animation-delay: 2s; }
        .sonar-circle:nth-child(4) { animation-delay: 3s; }

        @keyframes sonar-ping {
            0%   { width: 0;    height: 0;    opacity: 1; }
            100% { width: 100%; height: 100%; opacity: 0; }
        }

        .sonar-scanner {
            position: absolute;
            inset: 0;
            background: conic-gradient(from 0deg, transparent 0deg, var(--accent-blue) 360deg);
            opacity: 0.12;
            border-radius: 50%;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        .searching-text {
            font-size: 13px;
            font-weight: 800;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent-blue);
            text-shadow: 0 0 12px rgba(8, 217, 214, 0.4);
        }

        /* =============================================
           BOTTOM STATUS BAR
           ============================================= */
        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bar-height);
            background: rgba(0, 0, 0, 0.85);
            border-top: var(--divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 300;
        }

        .stat-group {
            display: flex;
            gap: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .stat-item span { color: #666; margin-right: 6px; }
        .stat-item b    { color: #fff; }

        .bar-center {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            font-weight: 700;
            color: #888;
            letter-spacing: 1px;
        }

        .conn-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #888;
        }

        .dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #ff4b2b;
        }

        .dot.online {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        /* =============================================
           VERTICAL DIVIDER between Emerald & Battles
           ============================================= */
        .panel-divider {
            width: 2px;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent,
                rgba(80, 250, 123, 0.3) 20%,
                rgba(8, 217, 214, 0.4) 50%,
                rgba(80, 250, 123, 0.3) 80%,
                transparent
            );
            flex-shrink: 0;
        }

        /* =============================================
           DEBUG PANEL
           ============================================= */
        .debug-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 11px;
            color: #e5e5e5;
            max-width: 320px;
            line-height: 1.5;
            pointer-events: none;
        }

        .debug-panel.hidden { display: none; }
        .debug-title { font-weight: 700; margin-bottom: 4px; color: #9ae6b4; }

        /* =============================================
           MAX SLOTS DISPLAY CONTROL
           ============================================= */
        body.max-slots-1 #slot2,
        body.max-slots-1 #slot3 { display: none; }
        body.max-slots-2 #slot3 { display: none; }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- ==========================================
             EMERALD AI PANEL (Left 55%)
             ========================================== -->
        <div class="emerald-panel" id="emeraldPanel">

            <!-- Idle/waiting overlay -->
            <div class="emerald-idle" id="emeraldIdle">
                <div class="emerald-logo">
                    <div class="emerald-icon">ðŸŒ¿</div>
                    <div class="emerald-title">EMERALD AI</div>
                    <div class="emerald-sub">Claude plays PokÃ©mon Emerald</div>
                </div>
                <div class="emerald-status-text" id="emeraldStatusText">AWAITING GAME FEED...</div>
            </div>

            <!-- Live game iframe -->
            <iframe id="emeraldFrame" title="Emerald AI"></iframe>

            <!-- Top-left badge -->
            <div class="emerald-header">
                <div class="badge green">EMERALD AI</div>
                <div class="badge dim" id="emeraldStatusBadge">OFFLINE</div>
            </div>
        </div>

        <!-- Glowing vertical divider -->
        <div class="panel-divider"></div>

        <!-- ==========================================
             PS BATTLES PANEL (Right 45%) â€” 3 stacked slots
             ========================================== -->
        <div class="battles-panel">

            <!-- Slot 1 -->
            <div class="battle-slot" id="slot1">
                <div class="searching-overlay" id="searching1">
                    <div class="sonar">
                        <div class="sonar-scanner"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                    </div>
                    <div class="searching-text">SCANNING...</div>
                </div>

                <iframe id="frame1"></iframe>

                <div class="ui-layer">
                    <div class="slot-header">
                        <div class="badge red">W-01</div>
                        <div class="badge">LIVE</div>
                    </div>
                    <div class="battle-card" id="card1">
                        <div class="opp-info">
                            <h4>Opponent</h4>
                            <div id="opp1">----------</div>
                        </div>
                        <div class="match-stats">
                            <div class="turn">ACTIVE</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slot 2 -->
            <div class="battle-slot" id="slot2">
                <div class="searching-overlay" id="searching2">
                    <div class="sonar">
                        <div class="sonar-scanner"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                    </div>
                    <div class="searching-text">SCANNING...</div>
                </div>

                <iframe id="frame2"></iframe>

                <div class="ui-layer">
                    <div class="slot-header">
                        <div class="badge blue">W-02</div>
                        <div class="badge">LIVE</div>
                    </div>
                    <div class="battle-card" id="card2">
                        <div class="opp-info">
                            <h4>Opponent</h4>
                            <div id="opp2">----------</div>
                        </div>
                        <div class="match-stats">
                            <div class="turn">ACTIVE</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slot 3 -->
            <div class="battle-slot" id="slot3">
                <div class="searching-overlay" id="searching3">
                    <div class="sonar">
                        <div class="sonar-scanner"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                        <div class="sonar-circle"></div>
                    </div>
                    <div class="searching-text">SCANNING...</div>
                </div>

                <iframe id="frame3"></iframe>

                <div class="ui-layer">
                    <div class="slot-header">
                        <div class="badge purple">W-03</div>
                        <div class="badge">LIVE</div>
                    </div>
                    <div class="battle-card" id="card3">
                        <div class="opp-info">
                            <h4>Opponent</h4>
                            <div id="opp3">----------</div>
                        </div>
                        <div class="match-stats">
                            <div class="turn">ACTIVE</div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /.battles-panel -->
    </div><!-- /.app-container -->

    <!-- ==========================================
         BOTTOM STATUS BAR (full width)
         ========================================== -->
    <div class="bottom-bar">
        <div class="stat-group">
            <div class="stat-item"><span>W</span><b id="totalWins">0</b></div>
            <div class="stat-item"><span>L</span><b id="totalLosses">0</b></div>
            <div class="stat-item"><span>ELO</span><b id="totalElo">----</b></div>
        </div>

        <div class="bar-center">
            <span>ALL CHUNG</span>
            <span style="color:#333">|</span>
            <span>GEN 9 OU</span>
            <span style="color:#333">|</span>
            <span>3Ã— CONCURRENT</span>
        </div>

        <div class="conn-status">
            <div class="dot" id="connDot"></div>
            <span id="connText">OFFLINE</span>
        </div>
    </div>

    <!-- Debug panel -->
    <div id="debugPanel" class="debug-panel hidden">
        <div class="debug-title">OBS DEBUG v3</div>
        <div id="debugConn">WS: -</div>
        <div id="debugUpdated">Last: -</div>
        <div id="debugSlot1">Slot1: -</div>
        <div id="debugSlot2">Slot2: -</div>
        <div id="debugSlot3">Slot3: -</div>
        <div id="debugEmerald">Emerald: -</div>
    </div>

    <script>
        const host = window.location.hostname;
        const port = window.location.port || '8777';
        const wsUrl = `ws://${host}:${port}/ws`;
        const httpBase = `http://${host}:${port}`;
        let socket = null;
        let wsOnline = false;
        const currentBattles = {};
        const currentBattleUrls = {};
        const slotReloadTimers = { 1: [], 2: [], 3: [] };
        let maxSlots = 3;

        // URL params
        const params = new URLSearchParams(window.location.search);
        const forceSlot = params.get('slot');
        const debugEnabled = params.get('debug') === '1';
        if (debugEnabled) document.getElementById('debugPanel').classList.remove('hidden');

        // ---- Emerald Panel ----
        let emeraldOnline = false;

        function setEmeraldOnline(url) {
            const frame = document.getElementById('emeraldFrame');
            const idle = document.getElementById('emeraldIdle');
            const badge = document.getElementById('emeraldStatusBadge');
            if (frame.src !== url) {
                frame.src = url;
                frame.classList.add('visible');
            }
            idle.classList.add('hidden');
            badge.textContent = 'LIVE';
            badge.classList.remove('dim');
            badge.classList.add('green');
            emeraldOnline = true;
        }

        function setEmeraldOffline(msg) {
            const frame = document.getElementById('emeraldFrame');
            const idle = document.getElementById('emeraldIdle');
            const badge = document.getElementById('emeraldStatusBadge');
            const statusText = document.getElementById('emeraldStatusText');
            frame.classList.remove('visible');
            idle.classList.remove('hidden');
            badge.textContent = 'OFFLINE';
            badge.classList.add('dim');
            badge.classList.remove('green');
            if (msg) statusText.textContent = msg;
            emeraldOnline = false;
        }

        // ---- Slot Management ----
        function removeSlots(nums) {
            nums.forEach(n => { const el = document.getElementById(`slot${n}`); if (el) el.remove(); });
        }

        if (forceSlot === '1') { document.body.classList.add('single-slot-1'); removeSlots([2, 3]); maxSlots = 1; }
        if (forceSlot === '2') { document.body.classList.add('single-slot-2'); removeSlots([1, 3]); maxSlots = 1; }
        if (forceSlot === '3') { document.body.classList.add('single-slot-3'); removeSlots([1, 2]); maxSlots = 1; }

        function connect() {
            socket = new WebSocket(wsUrl);
            socket.onopen = () => {
                wsOnline = true;
                document.getElementById('connDot').classList.add('online');
                document.getElementById('connText').textContent = 'REAL-TIME';
            };
            socket.onerror = () => { try { socket.close(); } catch(e) {} };
            socket.onclose = () => {
                wsOnline = false;
                document.getElementById('connDot').classList.remove('online');
                document.getElementById('connText').textContent = 'OFFLINE';
                setTimeout(connect, 2000);
            };
            socket.onmessage = (event) => {
                try { handleEvent(JSON.parse(event.data)); } catch(e) {}
            };
        }

        function handleEvent(msg) {
            const { type, payload } = msg;
            if (!payload) return;

            if (type === 'INIT' || type === 'STATE_UPDATE') {
                if (payload.status)    updateStats(payload.status);
                if (payload.max_slots) applyMaxSlots(payload.max_slots);
                if (payload.battles)   syncSlots(payload.battles);
                if (payload.emerald !== undefined) handleEmeraldState(payload.emerald);
                updateDebug(payload);
            }

            // Dedicated emerald event
            if (type === 'emerald' || type === 'EMERALD_UPDATE') {
                handleEmeraldState(payload);
            }
        }

        function handleEmeraldState(data) {
            if (!data) return;
            if (data.url) {
                setEmeraldOnline(data.url);
            } else if (data.status === 'offline' || data.offline) {
                setEmeraldOffline(data.message || 'AWAITING GAME FEED...');
            }
            if (debugEnabled) {
                document.getElementById('debugEmerald').textContent = `Emerald: ${data.url || data.status || 'unknown'}`;
            }
        }

        function applyMaxSlots(value) {
            if (forceSlot) return;
            const parsed = parseInt(value);
            if (isNaN(parsed) || parsed <= 0) return;
            maxSlots = Math.max(1, Math.min(3, parsed));
            document.body.classList.remove('max-slots-1', 'max-slots-2');
            if (maxSlots === 1) document.body.classList.add('max-slots-1');
            else if (maxSlots === 2) document.body.classList.add('max-slots-2');
        }

        function withCacheBust(url, cb) {
            if (!cb) return url;
            const parts = url.split('#');
            const base = parts[0];
            const hash = parts.length > 1 ? `#${parts.slice(1).join('#')}` : '';
            const joiner = base.includes('?') ? '&' : '?';
            return `${base}${joiner}r=${cb}${hash}`;
        }

        function stripCacheBust(url) {
            if (!url) return url;
            const parts = url.split('#');
            const base = parts[0];
            const hash = parts.length > 1 ? `#${parts.slice(1).join('#')}` : '';
            const bp = base.split('?');
            if (bp.length < 2) return url;
            const p = new URLSearchParams(bp[1]);
            p.delete('r');
            const q = p.toString();
            return `${bp[0]}${q ? `?${q}` : ''}${hash}`;
        }

        function getBattleUrl(battle) {
            if (!battle) return null;
            const raw = battle.url || `https://play.pokemonshowdown.com/${battle.id}`;
            return stripCacheBust(raw);
        }

        function clearSlotReloadTimers(num) {
            if (!slotReloadTimers[num]) return;
            slotReloadTimers[num].forEach(t => clearTimeout(t));
            slotReloadTimers[num] = [];
        }

        function scheduleInviteReload(num, bid, baseUrl) {
            clearSlotReloadTimers(num);
            [4000, 10000, 18000, 30000].forEach((delay, idx) => {
                const t = setTimeout(() => {
                    if (currentBattles[`slot${num}`] !== bid) return;
                    const frame = document.getElementById(`frame${num}`);
                    if (!frame) return;
                    frame.src = withCacheBust(baseUrl || `https://play.pokemonshowdown.com/${bid}`, Date.now() + idx);
                }, delay);
                slotReloadTimers[num].push(t);
            });
        }

        function updateSlot(num, battle) {
            const frame   = document.getElementById(`frame${num}`);
            const overlay = document.getElementById(`searching${num}`);
            const card    = document.getElementById(`card${num}`);
            const oppText = document.getElementById(`opp${num}`);
            if (!frame || !overlay || !card || !oppText) return;

            const bid = battle.id;
            const battleUrl = getBattleUrl(battle);
            currentBattles[`slot${num}`] = bid;
            currentBattleUrls[`slot${num}`] = battleUrl;
            oppText.textContent = battle.opponent || '----------';

            frame.src = withCacheBust(battleUrl, Date.now());
            overlay.classList.add('hidden');
            frame.classList.add('visible');
            setTimeout(() => card.classList.add('show'), 400);
            scheduleInviteReload(num, bid, battleUrl);
        }

        function resetSlot(num) {
            const frame   = document.getElementById(`frame${num}`);
            const overlay = document.getElementById(`searching${num}`);
            const card    = document.getElementById(`card${num}`);
            if (!frame || !overlay || !card) return;

            currentBattles[`slot${num}`] = null;
            currentBattleUrls[`slot${num}`] = null;
            clearSlotReloadTimers(num);
            card.classList.remove('show');
            frame.classList.remove('visible');
            setTimeout(() => { frame.src = 'about:blank'; overlay.classList.remove('hidden'); }, 500);
        }

        function shouldUpdateSlot(num, battle) {
            return currentBattles[`slot${num}`] !== battle.id ||
                   currentBattleUrls[`slot${num}`] !== getBattleUrl(battle);
        }

        function syncSlots(battles) {
            const active = battles || [];
            const slotMap = {};
            active.forEach((b, idx) => { slotMap[b.slot || (idx + 1)] = b; });

            if (forceSlot) {
                const n = parseInt(forceSlot);
                const b = slotMap[n];
                if (b) { if (shouldUpdateSlot(n, b)) updateSlot(n, b); }
                else if (currentBattles[`slot${n}`]) resetSlot(n);
                return;
            }

            [1, 2, 3].forEach(num => {
                if (num > maxSlots) { if (currentBattles[`slot${num}`]) resetSlot(num); return; }
                const b = slotMap[num];
                if (b) { if (shouldUpdateSlot(num, b)) updateSlot(num, b); }
                else if (currentBattles[`slot${num}`]) resetSlot(num);
            });
        }

        function updateStats(data) {
            if (!data) return;
            if (data.wins     !== undefined) document.getElementById('totalWins').textContent    = data.wins;
            if (data.losses   !== undefined) document.getElementById('totalLosses').textContent  = data.losses;
            if (data.elo)                    document.getElementById('totalElo').textContent     = data.elo;
        }

        function updateDebug(payload) {
            if (!debugEnabled) return;
            document.getElementById('debugConn').textContent    = `WS: ${wsOnline ? 'ONLINE' : 'OFFLINE'}`;
            document.getElementById('debugUpdated').textContent = `Last: ${new Date().toLocaleTimeString()}`;
            const battles = (payload && payload.battles) || [];
            const sm = {};
            battles.forEach((b, i) => { sm[b.slot || (i+1)] = b; });
            [1,2,3].forEach(n => {
                document.getElementById(`debugSlot${n}`).textContent = `Slot${n}: ${sm[n] ? sm[n].id : '-'}`;
            });
        }

        async function fetchStateFallback() {
            try {
                const resp = await fetch(`${httpBase}/state?t=${Date.now()}`, { cache: 'no-store' });
                const data = await resp.json();
                if (data.status)  updateStats(data.status);
                if (data.battles) syncSlots(data.battles);
                if (data.emerald) handleEmeraldState(data.emerald);
                updateDebug(data);
            } catch(e) {}
        }

        // Boot
        connect();
        setInterval(() => { if (!wsOnline) fetchStateFallback(); }, 5000);
        fetchStateFallback();
    </script>
</body>

</html>
